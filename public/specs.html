<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>開発仕様 - AI PM Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header id="header-placeholder" class="app-header"></header>

    <main class="container">
        <div class="static-page-container">
            <h1>「AI Product Manager Dashboard」開発仕様書</h1>
            <p>最終更新日: 2025年8月14日</p>
    
            <h2>1. 概要</h2>
            <p>本アプリケーションは、AIプロダクトマネージャーを目指すユーザーが必要とする情報を戦略的な視点から提供するWebアプリケーションです。最新のAIツール市場の俯瞰、重要ニュースの分析、ツール提供企業の基礎情報、そしてデータに関する対話型AIアシスタント機能などを提供します。</p>
    
            <h2>2. アーキテクチャ</h2>
            <p>Google Cloudのサーバーレスサービスを中心に構築されています。ソースコードはGitHubで管理され、`main`ブランチへのプッシュをトリガーとして、Cloud BuildがテストとCloud Runへのデプロイを自動的に実行するCI/CDパイプラインも構成されています。</p>
            <ul>
                <li><strong>フロントエンド:</strong> Firebase Hosting</li>
                <li><strong>バックエンド:</strong> Google Cloud Run (Python / Flask)</li>
                <li><strong>データソース (ツールマップ):</strong> <code>backend/data.py</code> 内の静的データ</li>
                <li><strong>APIキー管理:</strong> Google Cloud Secret Manager</li>
                <li><strong>CI/CD:</strong> Google Cloud Build</li>
            </ul>

            <h2>3. 技術スタックとAPI</h2>
            <ul>
                <li><strong>ソースコード管理</strong>: GitHub</li>
                <li><strong>バックエンド</strong>: Python, Flask, Gunicorn</li>
                <li><strong>フロントエンド</strong>: HTML, CSS, JavaScript (Vanilla JS)</li>
                <li><strong>主要Google Cloudサービス</strong>:
                    <ul>
                        <li><strong>Cloud Run</strong>: バックエンドAPIの実行環境。</li>
                        <li><strong>Firebase Hosting</strong>: フロントエンドのホスティング。</li>
                        <li><strong>Secret Manager</strong>: APIキーの安全な保管。</li>
                        <li><strong>Cloud Build</strong>: CI/CDの自動化。</li>
                    </ul>
                </li>
                 <li><strong>利用外部API</strong>:
                    <ul>
                        <li><strong>Gemini API (<code>gemini-1.5-flash-latest</code>)</strong>: ニュース分析およびRAGアシスタント機能の中核。</li>
                        <li><strong>国税庁 法人番号システムWeb-API</strong>: 企業情報の取得。</li>
                        <li>各種RSSフィード</li>
                    </ul>
                </li>
            </ul>

            <h3>バックエンドAPIエンドポイント</h3>
            <dl>
                <dt><code>GET /</code></dt>
                <dd>ツールマップページの全てのカテゴリーとツール情報をJSON形式で返却します。</dd>
                
                <dt><code>GET /api/news</code></dt>
                <dd>複数のRSSフィードから最新ニュースを取得し、Gemini APIで重要度分析と要約を行ったトップ5のニュースを返却します。</dd>

                <dt><code>GET /api/corporate_info</code></dt>
                <dd>企業名（<code>name</code>クエリパラメータ）を受け取り、国税庁APIを呼び出して企業の公式情報を返却します。(注: 現在はAPIキー認可待ちのため、`main.py`内でロジックは有効化済みですが利用には注意が必要です)</dd>

                <dt><code>POST /api/chat</code></dt>
                <dd>ユーザーからの質問(<code>question</code>)を受け取り、RAG(検索拡張生成)を用いて回答を生成します。ダッシュボード内の関連情報をコンテキストとして利用し、関連情報がない場合はGeminiの汎用知識で応答するハイブリッド型です。</dd>
            </dl>
    
            <h2>4. 保守・運用手順</h2>
            <h3>4.1. 開発フロー</h3>
            <p>開発やデバッグは主に手動デプロイで行い、確定した変更をGitHubに反映させるフローを推奨します。</p>
            <ol>
                <li>ローカル環境（Cloud Shellなど）でコードを編集・変更します。</li>
                <li>動作確認のため、手動でCloud RunやFirebase Hostingにデプロイします。
                    <br>例: <code>gcloud run deploy ai-product-manager-backend --source ./backend ...</code>
                </li>
                <li>機能が完成したら、変更内容をGitでコミットし、GitHubの<code>main</code>ブランチにプッシュします。
                    <br><code>git add .</code>, <code>git commit -m "変更内容"</code>, <code>git push origin main</code>
                </li>
                <li>(CI/CD設定時) プッシュをトリガーに、Cloud Buildが自動でテストとデプロイを実行します。</li>
            </ol>

            <h3>4.2. GitHubリポジトリとの連携設定</h3>
            <p>Cloud BuildとGitHubリポジトリを初めて連携させる手順です。</p>
            <ol>
                <li>Google Cloudコンソールの「Cloud Build」ページで「トリガー」を選択します。</li>
                <li>「リポジトリを接続」をクリックし、画面の指示に従ってGitHubアカウントと対象のリポジトリを接続します。</li>
                <li>「トリガーを作成」をクリックし、<code>main</code>ブランチへのプッシュをトリガーとして設定します。</li>
                <li>構成ファイルとしてリポジトリ内の<code>cloudbuild.yaml</code>を指定します。</li>
            </ol>

            <h2>5. トラブルシューティング</h2>

            <h3>5.1. コード変更が反映されない / 503 Service Unavailableエラー</h3>
            <p><strong>症状</strong>: <code>data.py</code>等を変更してデプロイしても動作に反映されない。または、サービスURLにアクセスすると「Service Unavailable」と表示され、サーバーがクラッシュしている。</p>
            <p><strong>原因と解決策</strong>:</p>
            <ul>
                <li><strong>原因A: 依存ライブラリの不足 (503エラーの主原因)</strong>
                    <br><code>main.py</code>で<code>import</code>しているライブラリが、<code>backend/requirements.txt</code>に記載されていない場合、サーバーは起動に失敗しクラッシュします。Cloud Runの「ログ」で<code>ImportError</code>が出ていないか確認し、不足しているライブラリ（例: <code>google-cloud-secret-manager</code>）を<code>requirements.txt</code>に追記してください。
                </li>
                <li><strong>原因B: Gemini APIモデル名の変更</strong>
                    <br>APIのアップデートにより、古いモデル名（例: <code>gemini-pro</code>）が利用できなくなり、起動時またはAPI呼び出し時にエラーになることがあります。Cloud Runのログで<code>404 models/... is not found</code>というエラーが出ていないか確認し、コード内のモデル名を新しいもの（例: <code>gemini-1.5-flash-latest</code>）に更新してください。
                </li>
                <li><strong>原因C: Cloud Buildの強力なキャッシュ / サービスの状態異常</strong>
                    <br>軽微な変更だとCloud Buildが古いキャッシュを使ってデプロイしたり、サービスが不正な状態に陥ることが稀にあります。究極の解決策として、サービスを一度完全に削除し、ゼロから再作成することで問題は100%解決します。
                    <pre><code># 1. サービスを削除
gcloud run services delete ai-product-manager-backend --region=asia-northeast1

# 2. サービスを再作成（デプロイコマンドは同じ）
gcloud run deploy ai-product-manager-backend --source ./backend ...</code></pre>
                </li>
            </ul>

            <h3>5.2. Gitの初期設定とプッシュ失敗</h3>
            <p><strong>症状</strong>: <code>git commit</code>でエラーが出る、または<code>git push</code>で認証に失敗する。</p>
            <p><strong>原因と解決策</strong>:</p>
            <ul>
                <li><strong>ユーザー情報未設定</strong>: <code>git commit</code>が失敗する場合、Gitにユーザー情報が設定されていません。以下のコマンドで設定してください。
                    <pre><code>git config --global user.name "あなたの名前"
git config --global user.email "あなたのアドレス"</code></pre>
                </li>
                <li><strong>パスワード認証の廃止</strong>: <code>git push</code>で認証に失敗する場合、GitHubはパスワード認証をサポートしていません。代わりに**パーソナルアクセストークン(PAT)**を使用する必要があります。
                    <ol>
                        <li><a href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer">GitHubのトークン設定ページ</a>にアクセスします。</li>
                        <li>「Generate new token (classic)」を選択します。</li>
                        <li>Noteに名前を付け、Expiration（有効期限）を選択し、Scope（権限）で「<strong>repo</strong>」にチェックを入れます。</li>
                        <li>生成されたトークン（<code>ghp_...</code>）をコピーします。</li>
                        <li><code>git push</code>実行時にパスワードを求められたら、この**トークンを貼り付け**てください。</li>
                    </ol>
                </li>
            </ul>
            
            <h3>5.3. Cloud Shellでの認証エラー (localhost接続拒否)</h3>
            <p><strong>症状</strong>: <code>gcloud auth login</code> や <code>firebase login</code> を実行した際、ブラウザで<code>localhost</code>への接続が拒否され、認証が完了できない。</p>
            <p><strong>原因</strong>: Cloud Shellはクラウド上のリモート環境であり、ローカルPCのブラウザから直接<code>localhost</code>としてアクセスできないためです。</p>
            <p><strong>解決策</strong>: <code>localhost</code>を使用しない認証オプションをコマンドに追加します。</p>
            <pre><code>gcloud auth login --no-auth-browser
firebase login --no-localhost</code></pre>
        </div>
    </main>

    <script src="app.js"></script>
</body>
</html>